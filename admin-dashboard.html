<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Okinawa Admin Dashboard</title>
    
    <!-- TailwindCSS v3.4.10 CDN -->
    <script src="https://cdn.tailwindcss.com?v=3.4.10"></script>
    
    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#A61f23',
                        primaryDark: '#8a1a1f',
                        accent: '#cf2029'
                    }
                }
            }
        }
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-primary via-accent to-primaryDark p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-10 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="bg-gradient-to-r from-primary to-accent w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <i class="fas fa-shield-halved text-white text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Admin Portal</h1>
                <p class="text-gray-600">Okinawa Dashboard</p>
            </div>
            
            <form id="admin-login-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                    <input type="email" id="admin-email" value="admin@okinawa.com" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                    <input type="password" id="admin-password" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
                </div>
                
                <button type="submit" class="w-full px-6 py-4 bg-gradient-to-r from-primary to-accent text-white rounded-xl hover:shadow-xl transition-all duration-300 font-bold text-lg transform hover:scale-105">
                    <i class="fas fa-sign-in-alt mr-2"></i>
                    Access Dashboard
                </button>
                
                <div id="login-error" class="hidden text-center text-red-500 text-sm font-medium"></div>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-gradient-to-r from-primary via-accent to-primary text-white shadow-2xl sticky top-0 z-50 border-b-4 border-white/20">
            <div class="container mx-auto px-4 py-5">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-4">
                        <div class="bg-white/20 p-3 rounded-xl backdrop-blur-sm">
                            <i class="fas fa-store text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold">Okinawa Admin</h1>
                            <p class="text-white/80 text-sm">Management Dashboard</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <div class="bg-white/20 px-4 py-2 rounded-full text-sm font-medium backdrop-blur-sm">
                            <i class="fas fa-user-shield mr-2"></i>
                            Administrator
                        </div>
                        <button onclick="logout()" class="px-6 py-2.5 bg-white text-primary rounded-full hover:bg-gray-100 transition-all font-semibold shadow-lg hover:shadow-xl transform hover:scale-105">
                            <i class="fas fa-sign-out-alt mr-2"></i>
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="bg-white shadow-md sticky top-[88px] z-40">
            <div class="container mx-auto px-4">
                <div class="flex overflow-x-auto">
                    <button onclick="showTab('overview')" id="tab-overview" class="tab-button active px-6 py-4 font-semibold text-primary border-b-4 border-primary transition-all">
                        <i class="fas fa-chart-line mr-2"></i>
                        Overview
                    </button>
                    <button onclick="showTab('products')" id="tab-products" class="tab-button px-6 py-4 font-semibold text-gray-600 hover:text-primary hover:bg-gray-50 border-b-4 border-transparent transition-all">
                        <i class="fas fa-box mr-2"></i>
                        Products
                    </button>
                    <button onclick="showTab('orders')" id="tab-orders" class="tab-button px-6 py-4 font-semibold text-gray-600 hover:text-primary hover:bg-gray-50 border-b-4 border-transparent transition-all">
                        <i class="fas fa-shopping-cart mr-2"></i>
                        Orders
                    </button>
                    <button onclick="showTab('reviews')" id="tab-reviews" class="tab-button px-6 py-4 font-semibold text-gray-600 hover:text-primary hover:bg-gray-50 border-b-4 border-transparent transition-all">
                        <i class="fas fa-star mr-2"></i>
                        Reviews
                    </button>
                    <button onclick="showTab('customers')" id="tab-customers" class="tab-button px-6 py-4 font-semibold text-gray-600 hover:text-primary hover:bg-gray-50 border-b-4 border-transparent transition-all">
                        <i class="fas fa-users mr-2"></i>
                        Customers
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            
            <!-- Overview Tab -->
            <div id="content-overview" class="tab-content">
                <!-- Statistics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-2xl shadow-xl p-6 text-white transform hover:scale-105 transition-transform">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-blue-100 text-sm font-medium uppercase mb-2">Total Sales</p>
                                <h3 id="total-sales" class="text-4xl font-bold">$0</h3>
                            </div>
                            <div class="bg-white/20 p-4 rounded-xl backdrop-blur-sm">
                                <i class="fas fa-dollar-sign text-3xl"></i>
                            </div>
                        </div>
                        <p class="text-blue-100 text-sm">All-time revenue</p>
                    </div>

                    <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-2xl shadow-xl p-6 text-white transform hover:scale-105 transition-transform">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-green-100 text-sm font-medium uppercase mb-2">Total Orders</p>
                                <h3 id="total-orders" class="text-4xl font-bold">0</h3>
                            </div>
                            <div class="bg-white/20 p-4 rounded-xl backdrop-blur-sm">
                                <i class="fas fa-shopping-bag text-3xl"></i>
                            </div>
                        </div>
                        <p class="text-green-100 text-sm">Completed orders</p>
                    </div>

                    <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-2xl shadow-xl p-6 text-white transform hover:scale-105 transition-transform">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-purple-100 text-sm font-medium uppercase mb-2">Products</p>
                                <h3 id="total-products" class="text-4xl font-bold">0</h3>
                            </div>
                            <div class="bg-white/20 p-4 rounded-xl backdrop-blur-sm">
                                <i class="fas fa-box text-3xl"></i>
                            </div>
                        </div>
                        <p class="text-purple-100 text-sm">In catalog</p>
                    </div>

                    <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-2xl shadow-xl p-6 text-white transform hover:scale-105 transition-transform">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-orange-100 text-sm font-medium uppercase mb-2">Profit</p>
                                <h3 id="total-profit" class="text-4xl font-bold">$0</h3>
                            </div>
                            <div class="bg-white/20 p-4 rounded-xl backdrop-blur-sm">
                                <i class="fas fa-chart-line text-3xl"></i>
                            </div>
                        </div>
                        <p class="text-orange-100 text-sm">Total earnings</p>
                    </div>
                </div>

                <!-- Additional Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-yellow-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm font-medium mb-1">Total Reviews</p>
                                <h4 id="total-reviews" class="text-3xl font-bold text-gray-900">0</h4>
            </div>
                            <div class="bg-yellow-100 p-4 rounded-xl">
                                <i class="fas fa-star text-yellow-600 text-2xl"></i>
            </div>
                        </div>
    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-pink-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm font-medium mb-1">Wishlist Items</p>
                                <h4 id="total-wishlist" class="text-3xl font-bold text-gray-900">0</h4>
            </div>
                            <div class="bg-pink-100 p-4 rounded-xl">
                                <i class="fas fa-heart text-pink-600 text-2xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-indigo-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm font-medium mb-1">Registered Users</p>
                                <h4 id="total-users" class="text-3xl font-bold text-gray-900">0</h4>
                </div>
                            <div class="bg-indigo-100 p-4 rounded-xl">
                                <i class="fas fa-users text-indigo-600 text-2xl"></i>
                </div>
                </div>
                </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                        <i class="fas fa-clock text-primary"></i>
                        Recent Activity
                    </h3>
                    <div id="recent-activity" class="space-y-4">
                        <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                            <div class="bg-blue-100 p-3 rounded-full">
                                <i class="fas fa-shopping-bag text-blue-600"></i>
                    </div>
                            <div class="flex-1">
                                <p class="font-semibold text-gray-900">Loading activity...</p>
                                <p class="text-sm text-gray-600">Please wait</p>
                    </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products Tab -->
            <div id="content-products" class="tab-content hidden">
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
                            <i class="fas fa-box text-primary"></i>
                            Products Management
                        </h2>
                        <button onclick="openAddProductModal()" class="px-6 py-3 bg-gradient-to-r from-primary to-accent text-white rounded-xl hover:shadow-xl transition-all font-semibold">
                            <i class="fas fa-plus mr-2"></i>
                            Add Product
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                        <thead>
                                <tr class="bg-gradient-to-r from-gray-50 to-gray-100 border-b-2 border-gray-200">
                                    <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Product</th>
                                    <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Category</th>
                                    <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Price</th>
                                    <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Cost</th>
                                    <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Profit</th>
                                    <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Stock</th>
                                    <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Highlights</th>
                                    <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                            <tbody id="products-table-body" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="8" class="px-4 py-12 text-center text-gray-500">
                                    <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-primary border-t-transparent mb-3"></div>
                                    <p class="font-medium">Loading products...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                </div>
            </div>

            <!-- Orders Tab -->
            <div id="content-orders" class="tab-content hidden">
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                        <i class="fas fa-shopping-cart text-primary"></i>
                        Orders Management
                    </h2>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                        <thead>
                                <tr class="bg-gradient-to-r from-gray-50 to-gray-100 border-b-2 border-gray-200">
                                    <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Order ID</th>
                                    <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Customer</th>
                                    <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Date</th>
                                    <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Items</th>
                                    <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Total</th>
                                    <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Payment</th>
                                    <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Status</th>
                                    <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                            <tbody id="orders-table-body" class="divide-y divide-gray-200">
                            <tr>
                                    <td colspan="8" class="px-4 py-12 text-center text-gray-500">
                                        <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-primary border-t-transparent mb-3"></div>
                                        <p class="font-medium">Loading orders...</p>
                                    </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                </div>
            </div>

            <!-- Reviews Tab -->
            <div id="content-reviews" class="tab-content hidden">
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                        <i class="fas fa-star text-primary"></i>
                        Customer Reviews
                    </h2>
                    
                    <div id="reviews-list" class="space-y-4">
                        <div class="text-center py-12 text-gray-500">
                            <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-primary border-t-transparent mb-3"></div>
                            <p class="font-medium">Loading reviews...</p>
                </div>
                    </div>
                </div>
    </div>

            <!-- Customers Tab -->
            <div id="content-customers" class="tab-content hidden">
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                        <i class="fas fa-users text-primary"></i>
                        Customer Analytics
                    </h2>
                    
                    <div id="customers-list" class="space-y-4">
                        <div class="text-center py-12 text-gray-500">
                            <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-primary border-t-transparent mb-3"></div>
                            <p class="font-medium">Loading customer data...</p>
                </div>
                </div>
                </div>
                </div>

        </main>
                </div>

    <!-- Order Details Modal -->
    <div id="order-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-primary to-accent text-white">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold">Order Details</h3>
                    <button onclick="closeOrderModal()" class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                </div>
            <div id="order-details-content" class="p-6">
                <!-- Order details will be loaded here -->
                </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDzitihiLQetctKmv2-VLTvbZfftB3zOmw",
            authDomain: "okinawa-e5948.firebaseapp.com",
            projectId: "okinawa-e5948",
            storageBucket: "okinawa-e5948.firebasestorage.app",
            messagingSenderId: "1079558060579",
            appId: "1:1079558060579:web:93b7cc521ec819205bcf96",
            measurementId: "G-9GLB5N0GS2"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const ADMIN_EMAIL = 'admin@okinawa.com';
        let currentOrders = [];
        let currentProducts = [];

        // Tab Management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active', 'text-primary', 'border-primary');
                button.classList.add('text-gray-600', 'border-transparent');
            });
            
            // Show selected tab
            document.getElementById('content-' + tabName).classList.remove('hidden');
            
            // Mark button as active
            const activeButton = document.getElementById('tab-' + tabName);
            activeButton.classList.add('active', 'text-primary', 'border-primary');
            activeButton.classList.remove('text-gray-600', 'border-transparent');
            
            // Load data for the tab if needed
            if (tabName === 'overview') loadOverview();
            if (tabName === 'products') loadProducts();
            if (tabName === 'orders') loadOrders();
            if (tabName === 'reviews') loadReviews();
            if (tabName === 'customers') loadCustomers();
        }

        // Login
        document.getElementById('admin-login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const errorDiv = document.getElementById('login-error');

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                
                if (userCredential.user.email === ADMIN_EMAIL) {
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    loadOverview();
                } else {
                    await auth.signOut();
                    errorDiv.textContent = 'Access denied. Admin credentials required.';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = 'Login failed: ' + error.message;
                errorDiv.classList.remove('hidden');
            }
        });

        // Logout
        async function logout() {
                await auth.signOut();
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        }

        // Load Overview
        async function loadOverview() {
            try {
                const [ordersSnap, productsSnap, reviewsSnap, wishlistsSnap, usersSnap] = await Promise.all([
                    db.collection('orders').get(),
                    db.collection('products').get(),
                    db.collection('reviews').get(),
                    db.collection('wishlists').get(),
                    db.collection('users').get()
                ]);

                const orders = [];
                ordersSnap.forEach(doc => orders.push({ id: doc.id, ...doc.data() }));

                const products = [];
                productsSnap.forEach(doc => products.push({ id: doc.id, ...doc.data() }));

                // Calculate stats
                const totalSales = orders.reduce((sum, order) => sum + (order.totalAmount || order.total || 0), 0);
                const totalOrders = orders.length;
                const totalProducts = products.length;

                let totalProfit = 0;
                orders.forEach(order => {
                    if (order.items) {
                        order.items.forEach(item => {
                            const product = products.find(p => p.id === item.productId);
                            if (product && product.costPrice) {
                                const profit = (item.price - product.costPrice) * item.quantity;
                                totalProfit += profit;
                            }
                        });
                        }
                });

                // Update UI
                document.getElementById('total-sales').textContent = '$' + totalSales.toFixed(2);
                document.getElementById('total-orders').textContent = totalOrders;
                document.getElementById('total-products').textContent = totalProducts;
                document.getElementById('total-profit').textContent = '$' + totalProfit.toFixed(2);
                document.getElementById('total-reviews').textContent = reviewsSnap.size;
                
                let totalWishlistItems = 0;
                wishlistsSnap.forEach(doc => {
                    const data = doc.data();
                    totalWishlistItems += (data.products || []).length;
                });
                document.getElementById('total-wishlist').textContent = totalWishlistItems;
                document.getElementById('total-users').textContent = usersSnap.size;

                // Load recent activity
                loadRecentActivity(orders, reviewsSnap);

            } catch (error) {
                console.error('Error loading overview:', error);
            }
        }

        // Load Recent Activity
        function loadRecentActivity(orders, reviewsSnap) {
            const activityDiv = document.getElementById('recent-activity');
            let activities = [];

            // Add recent orders
            orders.slice(0, 3).forEach(order => {
                const date = order.date ? order.date.toDate().toLocaleDateString() : 'N/A';
                activities.push({
                    icon: 'shopping-bag',
                    color: 'blue',
                    title: `New Order #${order.id.substring(0, 8)}`,
                    description: `${order.customerInfo?.fullName || 'Customer'} - $${(order.totalAmount || 0).toFixed(2)}`,
                    time: date
                });
            });

            // Add recent reviews
            const reviews = [];
            reviewsSnap.forEach(doc => reviews.push(doc.data()));
            reviews.slice(0, 2).forEach(review => {
                activities.push({
                    icon: 'star',
                    color: 'yellow',
                    title: `New ${review.rating}-Star Review`,
                    description: review.comment?.substring(0, 50) + '...',
                    time: review.createdAt ? review.createdAt.toDate().toLocaleDateString() : 'N/A'
                });
            });

            activityDiv.innerHTML = activities.map(activity => `
                <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">
                    <div class="bg-${activity.color}-100 p-3 rounded-full">
                        <i class="fas fa-${activity.icon} text-${activity.color}-600"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-semibold text-gray-900">${activity.title}</p>
                        <p class="text-sm text-gray-600">${activity.description}</p>
                    </div>
                    <span class="text-xs text-gray-500">${activity.time}</span>
                </div>
            `).join('');
        }

        // Load Products
        async function loadProducts() {
            try {
                const tbody = document.getElementById('products-table-body');
                const snapshot = await db.collection('products').get();
                currentProducts = [];
                snapshot.forEach(doc => {
                    currentProducts.push({ id: doc.id, ...doc.data() });
                });

                if (currentProducts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500 font-medium">No products found</td></tr>';
                    return;
                }

                tbody.innerHTML = currentProducts.map(product => {
                    const sellPrice = product.sellPrice || product.price || 0;
                    const costPrice = product.costPrice || 0;
                    const profit = sellPrice - costPrice;
                    const displayCategory = product.mainCategory || product.category || 'N/A';
                    const displaySubcategory = product.subcategory || product.category || 'N/A';
                    
                    return `
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-4 py-4">
                                <div class="flex items-center gap-3">
                                    <img src="${product.image || 'https://via.placeholder.com/50'}" alt="${product.name}" class="w-12 h-12 rounded-lg object-cover">
                                    <div>
                                        <p class="font-semibold text-gray-900">${product.name}</p>
                                        <p class="text-xs text-gray-500">${displaySubcategory}</p>
                                    </div>
                                </div>
                        </td>
                            <td class="px-4 py-4">
                                <div>
                                    <p class="text-sm font-semibold text-gray-900">${displayCategory}</p>
                                    <p class="text-xs text-gray-500">${displaySubcategory}</p>
                                </div>
                            </td>
                            <td class="px-4 py-4">
                                <span class="font-bold text-gray-900">$${sellPrice.toFixed(2)}</span>
                            </td>
                            <td class="px-4 py-4">
                                <span class="text-gray-600">$${costPrice.toFixed(2)}</span>
                            </td>
                            <td class="px-4 py-4">
                                <span class="font-semibold ${profit > 0 ? 'text-green-600' : 'text-red-600'}">
                                    $${profit.toFixed(2)}
                                </span>
                            </td>
                            <td class="px-4 py-4">
                                <span class="px-3 py-1 rounded-full text-xs font-medium ${product.stock === 'In Stock' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                    ${product.stock || 'N/A'}
                                </span>
                            </td>
                            <td class="px-4 py-4">
                                <div class="flex flex-col gap-1">
                                    ${product.isBestSeller ? '<span class="px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-700 flex items-center gap-1"><i class="fas fa-fire"></i> Best Seller</span>' : ''}
                                    ${product.isNewArrival ? '<span class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700 flex items-center gap-1"><i class="fas fa-sparkles"></i> New Arrival</span>' : ''}
                                    ${!product.isBestSeller && !product.isNewArrival ? '<span class="text-xs text-gray-400">None</span>' : ''}
                                </div>
                            </td>
                            <td class="px-4 py-4">
                                <button onclick="editProduct('${product.id}')" class="text-blue-500 hover:text-blue-700 transition-colors p-2 mr-2" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteProduct('${product.id}')" class="text-red-500 hover:text-red-700 transition-colors p-2" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        // Load Orders
        async function loadOrders() {
            try {
                const tbody = document.getElementById('orders-table-body');
                const snapshot = await db.collection('orders').get();
                currentOrders = [];
                snapshot.forEach(doc => {
                    currentOrders.push({ id: doc.id, ...doc.data() });
                });

                // Sort by date (newest first)
                currentOrders.sort((a, b) => {
                    if (!a.date) return 1;
                    if (!b.date) return -1;
                    return b.date.toMillis() - a.date.toMillis();
                });

                if (currentOrders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500 font-medium">No orders found</td></tr>';
                return;
            }

                tbody.innerHTML = currentOrders.map(order => {
                    const date = order.date ? order.date.toDate().toLocaleDateString() : 'N/A';
                    const itemsCount = order.items ? order.items.length : 0;
                    const paymentMethod = order.paymentMethod || 'N/A';
                    const statusColor = {
                        'pending': 'bg-yellow-100 text-yellow-700',
                        'processing': 'bg-blue-100 text-blue-700',
                        'shipped': 'bg-purple-100 text-purple-700',
                        'delivered': 'bg-green-100 text-green-700',
                        'cancelled': 'bg-red-100 text-red-700'
                    };
                    const status = order.orderStatus || order.status || 'pending';
                    
                    return `
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-4 py-4 font-mono text-sm font-semibold text-gray-900">#${order.id.substring(0, 8)}</td>
                            <td class="px-4 py-4 text-sm text-gray-600">${order.customerInfo?.fullName || order.customerName || 'Unknown'}</td>
                            <td class="px-4 py-4 text-sm text-gray-600">${date}</td>
                            <td class="px-4 py-4 text-sm text-gray-600">${itemsCount} items</td>
                            <td class="px-4 py-4">
                                <span class="font-bold text-gray-900">$${(order.totalAmount || order.total || 0).toFixed(2)}</span>
                            </td>
                            <td class="px-4 py-4">
                                <span class="px-3 py-1 rounded-full text-xs font-medium ${paymentMethod === 'cash' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">
                                    ${paymentMethod === 'cash' ? 'Cash on Delivery' : 'Instapay'}
                            </span>
                        </td>
                            <td class="px-4 py-4">
                                <span class="px-3 py-1 rounded-full text-xs font-medium ${statusColor[status] || 'bg-gray-100 text-gray-700'}">
                                    ${status.charAt(0).toUpperCase() + status.slice(1)}
                                </span>
                            </td>
                            <td class="px-4 py-4">
                                <button onclick="viewOrder('${order.id}')" class="text-primary hover:text-primaryDark transition-colors p-2 mr-2" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="editOrderStatus('${order.id}')" class="text-blue-500 hover:text-blue-700 transition-colors p-2 mr-2" title="Edit Status">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteOrder('${order.id}')" class="text-red-500 hover:text-red-700 transition-colors p-2" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        // View Order Details
        function viewOrder(orderId) {
            const order = currentOrders.find(o => o.id === orderId);
            if (!order) return;

            const date = order.date ? order.date.toDate().toLocaleString() : 'N/A';
            const content = `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-blue-50 rounded-xl p-4">
                            <p class="text-xs text-gray-600 mb-1 uppercase">Order ID</p>
                            <p class="font-bold text-lg text-gray-900">#${order.id}</p>
                        </div>
                        <div class="bg-green-50 rounded-xl p-4">
                            <p class="text-xs text-gray-600 mb-1 uppercase">Order Date</p>
                            <p class="font-semibold text-gray-900">${date}</p>
                        </div>
                        <div class="bg-purple-50 rounded-xl p-4">
                            <p class="text-xs text-gray-600 mb-1 uppercase">User ID</p>
                            <p class="font-mono text-xs text-gray-900">${order.userId || 'N/A'}</p>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-bold text-lg mb-3 flex items-center gap-2">
                            <i class="fas fa-user text-primary"></i>
                            Customer Information
                        </h4>
                        <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-6 space-y-3">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-user-circle text-gray-400 text-xl"></i>
                                <div>
                                    <span class="text-xs text-gray-500">Full Name</span>
                                    <p class="font-semibold text-gray-900">${order.customerInfo?.fullName || 'N/A'}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <i class="fas fa-phone text-gray-400 text-xl"></i>
                                <div>
                                    <span class="text-xs text-gray-500">Phone Number</span>
                                    <p class="font-semibold text-gray-900">${order.customerInfo?.phone || 'N/A'}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <i class="fas fa-envelope text-gray-400 text-xl"></i>
                                <div>
                                    <span class="text-xs text-gray-500">Email Address</span>
                                    <p class="font-semibold text-gray-900">${order.customerInfo?.email || order.userEmail || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-bold text-lg mb-3 flex items-center gap-2">
                            <i class="fas fa-shipping-fast text-primary"></i>
                            Shipping/Delivery Address
                        </h4>
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6">
                            <div class="flex items-start gap-3">
                                <i class="fas fa-map-marker-alt text-blue-600 text-xl mt-1"></i>
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-900 text-lg">${order.deliveryAddress?.street || 'No street address'}</p>
                                    <p class="text-gray-700 mt-1">
                                        ${order.deliveryAddress?.city || 'N/A'}, 
                                        ${order.deliveryAddress?.state || 'N/A'} 
                                        ${order.deliveryAddress?.postalCode || ''}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-bold text-lg mb-3 flex items-center gap-2">
                            <i class="fas fa-credit-card text-primary"></i>
                            Payment Information
                        </h4>
                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-xs text-gray-600 mb-1 uppercase">Payment Method</p>
                                    <p class="font-bold text-lg text-gray-900">
                                        ${order.paymentMethod === 'cash' ? 'üíµ Cash on Delivery' : 'üí≥ Instapay'}
                                    </p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-600 mb-1 uppercase">Order Status</p>
                                    <p class="font-bold text-lg text-primary">
                                        ${(order.orderStatus || order.status || 'pending').toUpperCase()}
                                    </p>
                                </div>
                            </div>
                            ${order.instapayReference ? `
                                <div class="mt-4 pt-4 border-t border-green-200">
                                    <p class="text-xs text-gray-600 mb-1">Instapay Reference Number</p>
                                    <p class="font-mono text-lg font-bold text-blue-600">${order.instapayReference}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <div>
                        <h4 class="font-bold text-lg mb-3 flex items-center gap-2">
                            <i class="fas fa-box text-primary"></i>
                            Order Items (${(order.items || []).length} items)
                        </h4>
                        <div class="space-y-3">
                            ${(order.items || []).map(item => `
                                <div class="flex items-center gap-4 bg-gray-50 rounded-xl p-4 hover:bg-gray-100 transition-colors">
                                    ${item.image ? `<img src="${item.image}" alt="${item.name}" class="w-20 h-20 rounded-lg object-cover">` : '<div class="w-20 h-20 bg-gray-200 rounded-lg flex items-center justify-center"><i class="fas fa-image text-gray-400"></i></div>'}
                                    <div class="flex-1">
                                        <p class="font-bold text-gray-900">${item.name}</p>
                                        <p class="text-sm text-gray-600">
                                            $${item.price.toFixed(2)} √ó ${item.quantity} = 
                                            <span class="font-semibold text-primary">$${(item.price * item.quantity).toFixed(2)}</span>
                                        </p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    ${order.notes ? `
                        <div>
                            <h4 class="font-bold text-lg mb-3 flex items-center gap-2">
                                <i class="fas fa-sticky-note text-primary"></i>
                                Order Notes
                            </h4>
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 rounded-lg p-4">
                                <p class="text-gray-800">${order.notes}</p>
                            </div>
                        </div>
                    ` : ''}

                    <div class="bg-gradient-to-r from-primary to-accent text-white rounded-2xl p-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-white/80 text-sm uppercase mb-1">Order Total</p>
                                <p class="text-4xl font-bold">$${(order.totalAmount || order.total || 0).toFixed(2)}</p>
                            </div>
                            <i class="fas fa-receipt text-6xl text-white/20"></i>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('order-details-content').innerHTML = content;
            document.getElementById('order-modal').classList.remove('hidden');
        }

        function closeOrderModal() {
            document.getElementById('order-modal').classList.add('hidden');
        }

        // Edit Order Status
        function editOrderStatus(orderId) {
            const order = currentOrders.find(o => o.id === orderId);
            if (!order) return;

            const currentStatus = order.orderStatus || order.status || 'pending';
            const content = `
                <div class="space-y-6">
                    <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                        <i class="fas fa-edit text-primary"></i>
                        Update Order Status
                    </h3>
                    
                    <div class="bg-gray-50 rounded-xl p-4">
                        <p class="text-sm text-gray-600 mb-2">Order ID</p>
                        <p class="font-mono font-bold text-lg">#${order.id}</p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Order Status</label>
                        <select id="new-order-status" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent text-lg">
                            <option value="pending" ${currentStatus === 'pending' ? 'selected' : ''}>‚è≥ Pending</option>
                            <option value="processing" ${currentStatus === 'processing' ? 'selected' : ''}>üîÑ Processing</option>
                            <option value="shipped" ${currentStatus === 'shipped' ? 'selected' : ''}>üì¶ Shipped</option>
                            <option value="delivered" ${currentStatus === 'delivered' ? 'selected' : ''}>‚úÖ Delivered</option>
                            <option value="cancelled" ${currentStatus === 'cancelled' ? 'selected' : ''}>‚ùå Cancelled</option>
                        </select>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button onclick="saveOrderStatus('${order.id}')" class="flex-1 px-6 py-4 bg-gradient-to-r from-primary to-accent text-white rounded-xl hover:shadow-xl transition-all font-bold text-lg">
                            <i class="fas fa-save mr-2"></i>
                            Save Changes
                        </button>
                        <button onclick="closeOrderModal()" class="px-6 py-4 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-all font-semibold">
                            Cancel
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('order-details-content').innerHTML = content;
            document.getElementById('order-modal').classList.remove('hidden');
        }

        // Save Order Status
        async function saveOrderStatus(orderId) {
            const newStatus = document.getElementById('new-order-status').value;

            try {
                await db.collection('orders').doc(orderId).update({
                    orderStatus: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('‚úÖ Order status updated successfully!');
                closeOrderModal();
                loadOrders();
                loadOverview();
            } catch (error) {
                console.error('Error updating order:', error);
                alert('‚ùå Failed to update order: ' + error.message);
            }
        }

        // Add Product Modal
        function openAddProductModal() {
            const content = `
                <div class="space-y-6">
                    <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                        <i class="fas fa-plus-circle text-primary"></i>
                        Add New Product
                    </h3>
                    
                    <form id="add-product-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Product Name</label>
                            <input type="text" id="product-name" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Main Category</label>
                                <select id="product-main-category" required onchange="updateSubcategories('add')" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="">Select Category</option>
                                    <option value="Food & Beverage">üçú Food & Beverage</option>
                                    <option value="Beauty & Wellness">üå∏ Beauty & Wellness</option>
                                    <option value="Lifestyle & Home">üéã Lifestyle & Home</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Subcategory</label>
                                <select id="product-subcategory" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="">Select Main Category First</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Stock Status</label>
                            <select id="product-stock" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="In Stock">‚úÖ In Stock</option>
                                <option value="Out of Stock">‚ùå Out of Stock</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Sell Price ($)</label>
                                <input type="number" id="product-sell-price" step="0.01" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Cost Price ($)</label>
                                <input type="number" id="product-cost-price" step="0.01" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Image URL</label>
                            <input type="url" id="product-image" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                            <textarea id="product-description" rows="3" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                        </div>

                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-6 border-2 border-blue-200">
                            <p class="font-bold text-gray-900 mb-4 flex items-center gap-2">
                                <i class="fas fa-tags text-primary"></i>
                                Product Highlights
                            </p>
                            <div class="grid grid-cols-2 gap-4">
                                <label class="flex items-center gap-3 cursor-pointer bg-white rounded-lg p-4 hover:shadow-md transition-all border-2 border-transparent hover:border-blue-400">
                                    <input type="checkbox" id="product-best-seller" class="w-5 h-5 text-primary rounded focus:ring-2 focus:ring-primary">
                                    <div>
                                        <span class="font-semibold text-gray-900 flex items-center gap-2">
                                            <i class="fas fa-fire text-orange-500"></i>
                                            Best Seller
                            </span>
                                        <span class="text-xs text-gray-600">Featured on homepage</span>
                                    </div>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer bg-white rounded-lg p-4 hover:shadow-md transition-all border-2 border-transparent hover:border-green-400">
                                    <input type="checkbox" id="product-new-arrival" class="w-5 h-5 text-primary rounded focus:ring-2 focus:ring-primary">
                                    <div>
                                        <span class="font-semibold text-gray-900 flex items-center gap-2">
                                            <i class="fas fa-sparkles text-green-500"></i>
                                            New Arrival
                                        </span>
                                        <span class="text-xs text-gray-600">Show as new</span>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="flex gap-3 pt-4">
                            <button type="submit" class="flex-1 px-6 py-4 bg-gradient-to-r from-primary to-accent text-white rounded-xl hover:shadow-xl transition-all font-bold text-lg">
                                <i class="fas fa-plus mr-2"></i>
                                Add Product
                            </button>
                            <button type="button" onclick="closeOrderModal()" class="px-6 py-4 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-all font-semibold">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            `;

            document.getElementById('order-details-content').innerHTML = content;
            document.getElementById('order-modal').classList.remove('hidden');

            // Add form submit handler
            document.getElementById('add-product-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const mainCategory = document.getElementById('product-main-category').value;
                const subcategory = document.getElementById('product-subcategory').value;
                
                const productData = {
                    name: document.getElementById('product-name').value,
                    mainCategory: mainCategory,
                    category: subcategory,
                    subcategory: subcategory,
                    stock: document.getElementById('product-stock').value,
                    sellPrice: parseFloat(document.getElementById('product-sell-price').value),
                    price: parseFloat(document.getElementById('product-sell-price').value),
                    costPrice: parseFloat(document.getElementById('product-cost-price').value),
                    image: document.getElementById('product-image').value,
                    description: document.getElementById('product-description').value,
                    isBestSeller: document.getElementById('product-best-seller').checked,
                    isNewArrival: document.getElementById('product-new-arrival').checked,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    await db.collection('products').add(productData);
                    alert('‚úÖ Product added successfully!');
                    closeOrderModal();
                    loadProducts();
                    loadOverview();
            } catch (error) {
                    console.error('Error adding product:', error);
                    alert('‚ùå Failed to add product: ' + error.message);
                }
            });
        }

        // Load Reviews
        async function loadReviews() {
            try {
                const reviewsList = document.getElementById('reviews-list');
                const snapshot = await db.collection('reviews').get();

                if (snapshot.empty) {
                    reviewsList.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-star text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-600 font-medium">No reviews yet</p>
                        </div>
                    `;
                return;
            }

                const reviews = [];
                snapshot.forEach(doc => reviews.push({ id: doc.id, ...doc.data() }));

                // Get unique product IDs and user IDs
                const productIds = [...new Set(reviews.map(r => r.productId))];
                const userIds = [...new Set(reviews.map(r => r.userId).filter(Boolean))];
                
                const [productDocs, userDocs] = await Promise.all([
                    Promise.all(productIds.map(id => db.collection('products').doc(id).get())),
                    Promise.all(userIds.map(id => db.collection('users').doc(id).get()))
                ]);
                
                const productsMap = {};
                productDocs.forEach(doc => {
                    if (doc.exists) productsMap[doc.id] = doc.data();
                });

                const usersMap = {};
                userDocs.forEach(doc => {
                    if (doc.exists) usersMap[doc.id] = doc.data();
                });

                reviewsList.innerHTML = reviews.map(review => {
                    const product = productsMap[review.productId] || {};
                    const user = usersMap[review.userId] || {};
                    const userName = review.userName || user.displayName || user.email || 'Anonymous Customer';
                    const date = review.createdAt ? review.createdAt.toDate().toLocaleDateString() : 'N/A';
                    const stars = '‚òÖ'.repeat(review.rating) + '‚òÜ'.repeat(5 - review.rating);
                    
                    return `
                        <div class="bg-white border-2 border-gray-200 rounded-xl p-6 hover:shadow-lg transition-all">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex items-center gap-4">
                                    <img src="${product.image || 'https://via.placeholder.com/60'}" alt="${product.name || 'Product'}" class="w-16 h-16 rounded-lg object-cover shadow-md">
                                    <div>
                                        <h4 class="font-bold text-gray-900 text-lg">${product.name || 'Product Not Found'}</h4>
                                        <div class="flex items-center gap-2 mt-1">
                                            <i class="fas fa-user-circle text-gray-400"></i>
                                            <p class="text-sm font-semibold text-gray-700">${userName}</p>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="deleteReview('${review.id}')" class="text-red-500 hover:text-red-700 transition-colors px-3 py-2 rounded-lg hover:bg-red-50">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="flex items-center gap-3 mb-3">
                                <span class="text-yellow-500 text-2xl">${stars}</span>
                                <span class="text-sm text-gray-500">${date}</span>
                            </div>
                            <p class="text-gray-700 leading-relaxed">${review.comment || 'No comment provided'}</p>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading reviews:', error);
                reviewsList.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-exclamation-triangle text-6xl text-red-300 mb-4"></i>
                        <p class="text-red-600 font-medium">Error loading reviews: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Load Customers
        async function loadCustomers() {
            try {
                const customersList = document.getElementById('customers-list');
                const [usersSnap, ordersSnap, wishlistsSnap] = await Promise.all([
                    db.collection('users').get(),
                    db.collection('orders').get(),
                    db.collection('wishlists').get()
                ]);

                console.log('Users:', usersSnap.size, 'Orders:', ordersSnap.size, 'Wishlists:', wishlistsSnap.size);

                const orders = [];
                ordersSnap.forEach(doc => {
                    const orderData = doc.data();
                    orders.push({ ...orderData, id: doc.id });
                });

                const wishlists = {};
                wishlistsSnap.forEach(doc => {
                    const data = doc.data();
                    wishlists[doc.id] = (data.products || []).length;
                });

                const customers = [];
                usersSnap.forEach(doc => {
                    const userData = doc.data();
                    const userOrders = orders.filter(o => o.userId === doc.id);
                    const totalSpent = userOrders.reduce((sum, o) => {
                        const amount = o.totalAmount || o.total || 0;
                        console.log(`User ${doc.id} order ${o.id}: $${amount}`);
                        return sum + amount;
                    }, 0);
                    
                    console.log(`User ${doc.id} - Total: $${totalSpent}, Orders: ${userOrders.length}`);
                    
                    customers.push({
                        id: doc.id,
                        email: userData.email || 'N/A',
                        displayName: userData.displayName || userData.email || 'N/A',
                        orders: userOrders.length,
                        totalSpent: totalSpent,
                        wishlistItems: wishlists[doc.id] || 0
                    });
                });

                // Sort by total spent
                customers.sort((a, b) => b.totalSpent - a.totalSpent);

                if (customers.length === 0) {
                    customersList.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-users text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-600 font-medium">No customers found</p>
                        </div>
                    `;
                    return;
                }

                customersList.innerHTML = customers.map((customer, index) => `
                    <div class="bg-white border-2 border-gray-200 rounded-xl p-6 hover:shadow-lg transition-all">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-4">
                                <div class="bg-gradient-to-br from-primary to-accent text-white w-14 h-14 rounded-full flex items-center justify-center font-bold text-xl shadow-lg">
                                    ${index + 1}
                                </div>
                                <div>
                                    <h4 class="font-bold text-gray-900 text-lg">${customer.displayName}</h4>
                                    <p class="text-sm text-gray-600 flex items-center gap-2">
                                        <i class="fas fa-envelope"></i>
                                        ${customer.email}
                                    </p>
                                    <p class="text-xs text-gray-500 mt-1">User ID: ${customer.id.substring(0, 8)}...</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-3xl font-bold bg-gradient-to-r from-primary to-accent bg-clip-text text-transparent">
                                    $${customer.totalSpent.toFixed(2)}
                                </p>
                                <p class="text-xs text-gray-600 uppercase font-semibold">Total Spent</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-4 pt-4 border-t-2 border-gray-200">
                            <div class="bg-blue-50 rounded-lg p-3">
                                <p class="text-xs text-gray-600 mb-1 uppercase">Orders Placed</p>
                                <p class="text-2xl font-bold text-blue-600">${customer.orders}</p>
                            </div>
                            <div class="bg-pink-50 rounded-lg p-3">
                                <p class="text-xs text-gray-600 mb-1 uppercase">Wishlist Items</p>
                                <p class="text-2xl font-bold text-pink-600">${customer.wishlistItems}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading customers:', error);
                customersList.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-exclamation-triangle text-6xl text-red-300 mb-4"></i>
                        <p class="text-red-600 font-medium">Error loading customers: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Edit Product
        function editProduct(productId) {
            const product = currentProducts.find(p => p.id === productId);
            if (!product) return;

            const content = `
                <div class="space-y-6">
                    <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                        <i class="fas fa-edit text-primary"></i>
                        Edit Product
                    </h3>
                    
                    <form id="edit-product-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Product Name</label>
                            <input type="text" id="edit-product-name" value="${product.name || ''}" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Main Category</label>
                                <select id="edit-product-main-category" required onchange="updateSubcategories('edit')" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="">Select Category</option>
                                    <option value="Food & Beverage" ${product.mainCategory === 'Food & Beverage' ? 'selected' : ''}>üçú Food & Beverage</option>
                                    <option value="Beauty & Wellness" ${product.mainCategory === 'Beauty & Wellness' ? 'selected' : ''}>üå∏ Beauty & Wellness</option>
                                    <option value="Lifestyle & Home" ${product.mainCategory === 'Lifestyle & Home' ? 'selected' : ''}>üéã Lifestyle & Home</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Subcategory</label>
                                <select id="edit-product-subcategory" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="">Select Main Category First</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Stock Status</label>
                            <select id="edit-product-stock" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="In Stock" ${product.stock === 'In Stock' ? 'selected' : ''}>‚úÖ In Stock</option>
                                <option value="Out of Stock" ${product.stock === 'Out of Stock' ? 'selected' : ''}>‚ùå Out of Stock</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Sell Price ($)</label>
                                <input type="number" id="edit-product-sell-price" value="${product.sellPrice || product.price || 0}" step="0.01" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Cost Price ($)</label>
                                <input type="number" id="edit-product-cost-price" value="${product.costPrice || 0}" step="0.01" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Image URL</label>
                            <input type="url" id="edit-product-image" value="${product.image || ''}" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                            <textarea id="edit-product-description" rows="3" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">${product.description || ''}</textarea>
                        </div>

                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-6 border-2 border-blue-200">
                            <p class="font-bold text-gray-900 mb-4 flex items-center gap-2">
                                <i class="fas fa-tags text-primary"></i>
                                Product Highlights
                            </p>
                            <div class="grid grid-cols-2 gap-4">
                                <label class="flex items-center gap-3 cursor-pointer bg-white rounded-lg p-4 hover:shadow-md transition-all border-2 ${product.isBestSeller ? 'border-orange-400' : 'border-transparent'}">
                                    <input type="checkbox" id="edit-product-best-seller" ${product.isBestSeller ? 'checked' : ''} class="w-5 h-5 text-primary rounded focus:ring-2 focus:ring-primary">
                                    <div>
                                        <span class="font-semibold text-gray-900 flex items-center gap-2">
                                            <i class="fas fa-fire text-orange-500"></i>
                                            Best Seller
                                        </span>
                                        <span class="text-xs text-gray-600">Featured on homepage</span>
                                    </div>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer bg-white rounded-lg p-4 hover:shadow-md transition-all border-2 ${product.isNewArrival ? 'border-green-400' : 'border-transparent'}">
                                    <input type="checkbox" id="edit-product-new-arrival" ${product.isNewArrival ? 'checked' : ''} class="w-5 h-5 text-primary rounded focus:ring-2 focus:ring-primary">
                                    <div>
                                        <span class="font-semibold text-gray-900 flex items-center gap-2">
                                            <i class="fas fa-sparkles text-green-500"></i>
                                            New Arrival
                                        </span>
                                        <span class="text-xs text-gray-600">Show as new</span>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="flex gap-3 pt-4">
                            <button type="submit" class="flex-1 px-6 py-4 bg-gradient-to-r from-primary to-accent text-white rounded-xl hover:shadow-xl transition-all font-bold text-lg">
                                <i class="fas fa-save mr-2"></i>
                                Save Changes
                            </button>
                            <button type="button" onclick="closeOrderModal()" class="px-6 py-4 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-all font-semibold">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            `;

            document.getElementById('order-details-content').innerHTML = content;
            document.getElementById('order-modal').classList.remove('hidden');

            // Initialize subcategories for edit form
            setTimeout(() => {
                updateSubcategories('edit');
                // Set the subcategory value after subcategories are populated
                setTimeout(() => {
                    const subcatSelect = document.getElementById('edit-product-subcategory');
                    if (subcatSelect) {
                        subcatSelect.value = product.subcategory || product.category || '';
                    }
                }, 100);
            }, 100);

            // Add form submit handler
            document.getElementById('edit-product-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const mainCategory = document.getElementById('edit-product-main-category').value;
                const subcategory = document.getElementById('edit-product-subcategory').value;
                
                const productData = {
                    name: document.getElementById('edit-product-name').value,
                    mainCategory: mainCategory,
                    category: subcategory,
                    subcategory: subcategory,
                    stock: document.getElementById('edit-product-stock').value,
                    sellPrice: parseFloat(document.getElementById('edit-product-sell-price').value),
                    price: parseFloat(document.getElementById('edit-product-sell-price').value),
                    costPrice: parseFloat(document.getElementById('edit-product-cost-price').value),
                    image: document.getElementById('edit-product-image').value,
                    description: document.getElementById('edit-product-description').value,
                    isBestSeller: document.getElementById('edit-product-best-seller').checked,
                    isNewArrival: document.getElementById('edit-product-new-arrival').checked,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    await db.collection('products').doc(productId).update(productData);
                    alert('‚úÖ Product updated successfully!');
                    closeOrderModal();
                    loadProducts();
                    loadOverview();
                } catch (error) {
                    console.error('Error updating product:', error);
                    alert('‚ùå Failed to update product: ' + error.message);
                }
            });
        }

        // Delete Functions
        async function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    await db.collection('products').doc(id).delete();
                    alert('‚úÖ Product deleted successfully');
                    loadProducts();
                    loadOverview();
            } catch (error) {
                    alert('‚ùå Error deleting product: ' + error.message);
                }
            }
        }

        async function deleteOrder(id) {
            if (confirm('Are you sure you want to delete this order?')) {
                try {
                    await db.collection('orders').doc(id).delete();
                    alert('Order deleted successfully');
                    loadOrders();
                    loadOverview();
                } catch (error) {
                    alert('Error deleting order: ' + error.message);
                }
            }
        }

        async function deleteReview(id) {
            if (confirm('Are you sure you want to delete this review?')) {
                try {
                    await db.collection('reviews').doc(id).delete();
                    alert('Review deleted successfully');
                    loadReviews();
                    loadOverview();
                } catch (error) {
                    alert('Error deleting review: ' + error.message);
                }
            }
        }

        // Categories and Subcategories Data
        const categoriesData = {
            'Food & Beverage': [
                { value: 'Sake', label: 'üç∂ Sake - Premium beverages' },
                { value: 'Ramen', label: 'üçú Ramen - Authentic noodles' },
                { value: 'Snacks', label: 'üçø Snacks - Delicious treats' },
                { value: 'Miso', label: 'ü•£ Miso - Traditional soups' },
                { value: 'Yuzu', label: 'üçä Yuzu - Citrus freshness' },
                { value: 'Matcha', label: 'üçµ Matcha - Premium tea' }
            ],
            'Beauty & Wellness': [
                { value: 'Body Soap', label: 'üßº Body Soap - Natural cleansing' },
                { value: 'Hand Cream', label: 'ü§≤ Hand Cream - Nourishing care' },
                { value: 'Face Mask', label: 'üòå Face Mask - Hydration boost' },
                { value: 'Facial Tissue', label: 'üßª Facial Tissue - Ultra-soft' }
            ],
            'Lifestyle & Home': [
                { value: 'Chopsticks Holders', label: 'ü•¢ Chopsticks - Elegant dining' },
                { value: 'Matcha Set', label: 'üçÉ Matcha Set - Tea ceremony' },
                { value: 'Bag Hanger', label: 'üëú Bag Hanger - Practical style' },
                { value: 'Rice Soup Spoon', label: 'ü•Ñ Rice Spoon - Dining tools' },
                { value: 'Sushi Set', label: 'üç£ Sushi Set - Make sushi' },
                { value: 'Keychain', label: 'üîë Keychain - Culture style' },
                { value: 'Anime Drawing Book', label: 'üìö Drawing Book - Anime art' }
            ]
        };

        // Update Subcategories based on Main Category
        function updateSubcategories(formType) {
            const prefix = formType === 'add' ? 'product' : 'edit-product';
            const mainCategorySelect = document.getElementById(`${prefix}-main-category`);
            const subcategorySelect = document.getElementById(`${prefix}-subcategory`);
            
            if (!mainCategorySelect || !subcategorySelect) return;
            
            const selectedCategory = mainCategorySelect.value;
            
            // Clear existing options
            subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
            
            // Add subcategories based on selected main category
            if (selectedCategory && categoriesData[selectedCategory]) {
                categoriesData[selectedCategory].forEach(subcat => {
                    const option = document.createElement('option');
                    option.value = subcat.value;
                    option.textContent = subcat.label;
                    subcategorySelect.appendChild(option);
                });
                subcategorySelect.disabled = false;
            } else {
                subcategorySelect.innerHTML = '<option value="">Select Main Category First</option>';
                subcategorySelect.disabled = true;
            }
        }

        // Check if user is already logged in
        auth.onAuthStateChanged(user => {
            if (user && user.email === ADMIN_EMAIL) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                loadOverview();
            }
        });
    </script>
</body>
</html>
